- name: push transcribe service script to worker
  become: true
  ansible.builtin.copy:
    src: /home/almalinux/transcribe-{{ dataset_name }}.service # generated by the dataset role with the dataset name
    dest: /etc/systemd/system/transcribe-{{ dataset_name }}.service
  when: inventory_hostname in groups['workers']

- name: start transcription service
  become: true
  ansible.builtin.systemd_service:
    name: "transcribe-{{ dataset_name }}"
    state: restarted
    enabled: true
    daemon_reload: true
  when: inventory_hostname in groups['workers'] and inventory_hostname != groups['workers'][0]

- name: push concatenate script to worker
  ansible.builtin.copy:
    src: /home/almalinux/concatenate.sh # generated by the dataset role with the dataset name
    dest: /home/almalinux/
    owner: almalinux
    group: almalinux
    mode: '0755'
  when: inventory_hostname == groups['workers'][0]

- name: start slurm job
  ansible.builtin.shell: "sbatch --chdir=/home/almalinux --array=1-$(cat /home/almalinux/nfs/{{ dataset_name }}_filelist | wc -l) preprocess.sh"
  when: inventory_hostname in groups['host']
